<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0a">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’ª</text></svg>">
<title>Moj Trening</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { scroll-behavior: smooth; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0a0a0a;
  color: #fff;
  min-height: 100vh;
  min-height: 100dvh;
  padding: 12px 16px;
  padding-bottom: 90px;
  -webkit-font-smoothing: antialiased;
}

/* ====== HEADER ====== */
.header { text-align: center; padding: 16px 0 8px; }
.today-date {
  font-size: 13px; color: #666;
  text-transform: uppercase; letter-spacing: 2px;
}
.today-day {
  font-size: 28px; font-weight: 800; margin: 2px 0;
  background: linear-gradient(135deg, #fff, #ccc);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.page-title {
  font-size: 28px; font-weight: 800; text-align: center; padding: 16px 0;
  background: linear-gradient(135deg, #fff, #ccc);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.status-badge {
  display: inline-block; padding: 6px 20px; border-radius: 20px;
  font-size: 13px; font-weight: 700; margin-top: 6px; letter-spacing: 0.5px;
}
.status-training { background: linear-gradient(135deg, #00b894, #00cec9); color: #000; }
.status-rest { background: #1a1a1a; color: #666; border: 1px solid #333; }

/* ====== TRAINING CARD ====== */
.training-card {
  background: #141420;
  border: 1px solid #ffffff0a;
  border-radius: 20px;
  padding: 20px;
  margin: 16px 0;
}
.training-card h2, .training-card h3 {
  font-size: 20px; color: #00b894; margin-bottom: 2px;
}
.training-card .subtitle, .training-card .muscles-tag {
  font-size: 13px; color: #666; margin-bottom: 16px;
}

/* ====== EXERCISE LIST ====== */
.exercise-list { list-style: none; }
.exercise-item {
  display: flex; align-items: flex-start;
  padding: 14px 0;
  border-bottom: 1px solid #ffffff08;
}
.exercise-item:last-child { border-bottom: none; }
.exercise-num {
  width: 32px; height: 32px;
  background: #00b89420; color: #00b894;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 800;
  flex-shrink: 0; margin-right: 14px; margin-top: 2px;
}
.exercise-info { flex: 1; min-width: 0; }
.exercise-name { font-size: 15px; font-weight: 600; line-height: 1.3; }
.exercise-meta {
  display: flex; align-items: center; gap: 8px;
  margin-top: 4px; flex-wrap: wrap;
}
.exercise-sets {
  font-size: 12px; color: #888;
  background: #ffffff08; padding: 2px 8px; border-radius: 6px;
}
.exercise-timestamp {
  font-size: 11px; color: #6c5ce7; font-weight: 700;
  background: #6c5ce715; padding: 2px 8px; border-radius: 6px;
}
.video-btn {
  display: inline-flex; align-items: center; gap: 5px;
  background: #ff000018; color: #ff6b6b;
  font-size: 12px; font-weight: 700;
  padding: 6px 14px; border-radius: 10px;
  text-decoration: none; margin-top: 6px;
  border: 1px solid #ff000020;
  transition: background 0.15s;
}
.video-btn:active { background: #ff000035; }
.video-btn svg {
  width: 14px; height: 14px; fill: #ff6b6b;
}

/* ====== ABS SECTION ====== */
.abs-card {
  background: #1a1708;
  border: 1px solid #f0932b30;
  border-radius: 20px;
  padding: 20px; margin: 12px 0;
}
.abs-card h3 { font-size: 18px; color: #f0932b; margin-bottom: 2px; }
.abs-card .subtitle { font-size: 12px; color: #666; margin-bottom: 14px; }
.abs-exercise-num { background: #f0932b20; color: #f0932b; }

/* ====== MONTH CALENDAR ====== */
.month-calendar { margin: 28px 0 20px; }
.month-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.month-header h3 { font-size: 18px; color: #ddd; font-weight: 700; }
.month-nav {
  background: #1a1a1a; border: 1px solid #333;
  color: #aaa; font-size: 18px;
  width: 40px; height: 40px; border-radius: 12px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.month-nav:active { background: #333; }
.month-grid-header {
  display: grid; grid-template-columns: repeat(7, 1fr);
  gap: 4px; margin-bottom: 6px;
}
.month-grid-header div {
  text-align: center; font-size: 11px; color: #444;
  font-weight: 700; padding: 4px;
}
.month-grid {
  display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;
}
.mcell {
  background: #111; border-radius: 10px;
  padding: 8px 2px; text-align: center;
  min-height: 56px; cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.15s;
}
.mcell:active { transform: scale(0.95); }
.mcell.empty { background: transparent; cursor: default; }
.mcell.empty:active { transform: none; }
.mcell.today { border-color: #00b894; background: #00b89412; }
.mcell.training-day { background: #141420; }
.mcell .mday { font-size: 15px; font-weight: 700; color: #888; }
.mcell.today .mday { color: #00b894; }
.mcell.training-day .mday { color: #ccc; }
.mcell .mtraining {
  font-size: 9px; color: #00b894; font-weight: 800;
  margin-top: 2px;
}
.mcell .mabs-dot {
  width: 5px; height: 5px; background: #f0932b;
  border-radius: 50%; margin: 3px auto 0;
}

/* ====== DAY DETAIL POPUP ====== */
.day-detail-overlay {
  display: none; position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 200; align-items: flex-end; justify-content: center;
  backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
}
.day-detail-overlay.open { display: flex; }
.day-detail-panel {
  background: #151515;
  border-radius: 24px 24px 0 0;
  padding: 20px 20px;
  padding-bottom: max(24px, env(safe-area-inset-bottom));
  width: 100%; max-width: 500px;
  max-height: 88vh; overflow-y: auto;
  animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}
.day-detail-panel::-webkit-scrollbar { display: none; }
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
.panel-handle {
  width: 36px; height: 4px; background: #333;
  border-radius: 2px; margin: 0 auto 16px;
}
.day-detail-header {
  display: flex; justify-content: space-between;
  align-items: center; margin-bottom: 12px;
}
.day-detail-header h2 { font-size: 18px; font-weight: 700; }
.day-detail-close {
  background: #222; border: none; color: #888;
  width: 36px; height: 36px; border-radius: 50%;
  font-size: 20px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.day-detail-close:active { background: #333; }
.day-detail-badge {
  display: inline-block; padding: 4px 14px;
  border-radius: 16px; font-size: 12px;
  font-weight: 700; margin-bottom: 12px;
  margin-right: 6px;
}

/* ====== NEXT TRAININGS ====== */
.next-trainings { margin: 24px 0; }
.next-trainings h3 { font-size: 16px; color: #888; margin-bottom: 12px; font-weight: 700; }
.next-item {
  display: flex; align-items: center;
  padding: 14px 16px; background: #111;
  border-radius: 14px; margin-bottom: 8px;
  border: 1px solid #ffffff08;
  cursor: pointer;
}
.next-item:active { background: #1a1a2e; }
.next-date { width: 48px; text-align: center; margin-right: 14px; }
.next-date .d { font-size: 22px; font-weight: 800; }
.next-date .m { font-size: 10px; color: #666; font-weight: 600; }
.next-info { flex: 1; }
.next-info .name { font-size: 14px; font-weight: 700; }
.next-info .muscles { font-size: 12px; color: #666; margin-top: 1px; }
.next-abs-badge {
  background: #f0932b20; color: #f0932b;
  font-size: 10px; padding: 3px 10px;
  border-radius: 8px; font-weight: 700;
}

/* ====== REST ====== */
.rest-message { text-align: center; padding: 32px 20px; color: #444; }
.rest-message .icon { font-size: 40px; margin-bottom: 10px; }
.rest-message p { font-size: 15px; line-height: 1.5; }
.cycle-info {
  text-align: center; padding: 12px; color: #333; font-size: 12px;
}

/* ====== TABS ====== */
.tab-bar {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: #0d0d0d; border-top: 1px solid #1a1a1a;
  display: flex; padding: 6px 0;
  padding-bottom: max(6px, env(safe-area-inset-bottom));
  z-index: 100;
}
.tab {
  flex: 1; text-align: center; padding: 6px 8px;
  color: #444; font-size: 10px; font-weight: 700;
  cursor: pointer; border: none; background: none;
  transition: color 0.15s;
}
.tab.active { color: #00b894; }
.tab-icon { font-size: 22px; display: block; margin-bottom: 1px; }
.page { display: none; }
.page.active { display: block; }

/* ====== SETTINGS ====== */
.settings-section {
  background: #111; border-radius: 16px;
  padding: 20px; margin-bottom: 12px;
  border: 1px solid #ffffff08;
}
.settings-section h3 { font-size: 15px; margin-bottom: 10px; font-weight: 700; }
.settings-section label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; }
.settings-section input[type="date"] {
  width: 100%; padding: 12px;
  background: #1a1a1a; border: 1px solid #333;
  border-radius: 12px; color: #fff; font-size: 16px;
}
.settings-section p { font-size: 12px; color: #444; margin-top: 8px; line-height: 1.4; }
.calibrate-btn {
  flex: 1; padding: 14px;
  background: #1a1a1a; border: 1px solid #333;
  border-radius: 12px; color: #fff;
  font-size: 16px; font-weight: 800;
  cursor: pointer; transition: all 0.15s;
}
.calibrate-btn:active { background: #00b894; color: #000; border-color: #00b894; }

/* ====== ALL TRAININGS ====== */
.all-trainings .training-card { margin-bottom: 12px; }
</style>
</head>
<body>

<div id="page-home" class="page active">
  <div class="header">
    <div class="today-date" id="today-date"></div>
    <div class="today-day" id="today-day"></div>
    <div id="status-badge"></div>
  </div>
  <div id="today-content"></div>
  <div class="month-calendar">
    <div class="month-header">
      <button class="month-nav" onclick="changeMonth(-1)">&#8249;</button>
      <h3 id="month-title"></h3>
      <button class="month-nav" onclick="changeMonth(1)">&#8250;</button>
    </div>
    <div class="month-grid-header">
      <div>Pn</div><div>Wt</div><div>Sr</div><div>Cz</div><div>Pt</div><div>Sb</div><div>Nd</div>
    </div>
    <div class="month-grid" id="month-grid"></div>
  </div>
  <div class="next-trainings">
    <h3>Nadchodzace treningi</h3>
    <div id="next-list"></div>
  </div>
  <div class="cycle-info" id="cycle-info"></div>
</div>

<div id="page-all" class="page">
  <div class="page-title">Treningi</div>
  <div class="all-trainings" id="all-trainings"></div>
</div>

<div id="page-settings" class="page">
  <div class="page-title">Ustawienia</div>
  <div class="settings-section">
    <h3>Data startu cyklu</h3>
    <label>Poniedzialek pierwszego tygodnia cyklu:</label>
    <input type="date" id="start-date-input">
    <p>Ustaw poniedzialek tygodnia, od ktorego zaczynasz Tydzien 1.</p>
  </div>
  <div class="settings-section">
    <h3>Kalibracja treningow</h3>
    <label>Jaki trening miales dzisiaj (lub ostatnio)?</label>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button class="calibrate-btn" onclick="calibrate(0)">T1</button>
      <button class="calibrate-btn" onclick="calibrate(1)">T2</button>
      <button class="calibrate-btn" onclick="calibrate(2)">T3</button>
      <button class="calibrate-btn" onclick="calibrate(3)">T4</button>
    </div>
    <p>Kliknij numer treningu, zeby skalibrowaÄ‡ kolejnosc.</p>
  </div>
</div>

<div class="day-detail-overlay" id="day-detail-overlay" onclick="closeDayDetail(event)">
  <div class="day-detail-panel" id="day-detail-panel"></div>
</div>

<div class="tab-bar">
  <button class="tab active" onclick="showPage('home')">
    <span class="tab-icon">&#127968;</span>Dzisiaj
  </button>
  <button class="tab" onclick="showPage('all')">
    <span class="tab-icon">&#128170;</span>Treningi
  </button>
  <button class="tab" onclick="showPage('settings')">
    <span class="tab-icon">&#9881;</span>Ustawienia
  </button>
</div>

<script>
const TRAININGS = [
  {
    name: "Trening 1",
    muscles: "Plecy, Barki, Triceps",
    exercises: [
      { name: "Sciaganie drazka wyciagu gornego do klatki piersiowej", sets: 3, reps: "12, 10, 8", video: "https://youtube.com/shorts/Le1klm9Bs5s?si=XVFblMKMenvJ0mz7" },
      { name: "Sciaganie linki na najszerszy grzbietu", sets: 3, reps: "12, 12, 10", video: "https://youtube.com/shorts/TkTD5h8-Mdw?si=ttSO-fzmDfxhoiYC" },
      { name: "Sciaganie linki jednoracz siedzac", sets: 3, reps: "10, 10, 8", video: "https://www.youtube.com/watch?v=1jN6qeXdvWA" },
      { name: "Unoszenie hantla na barki lezac", sets: 3, reps: "12", video: "https://youtube.com/shorts/Y_V15Zu2cGo?feature=share" },
      { name: "Francuskie wyciskanie sztangi", sets: 3, reps: "12, 10, 10", ts: "2:17", video: "https://www.youtube.com/watch?v=TJkoGDIdRYk&t=46s" },
      { name: "Prostowanie jednoracz na triceps", sets: 3, reps: "12", video: "https://www.youtube.com/shorts/Sf7gJnFqMAs" }
    ]
  },
  {
    name: "Trening 2",
    muscles: "Klatka, Bok Barku, Biceps",
    exercises: [
      { name: "Wyciskanie hantli na lawce plaskiej", sets: 3, reps: "12", video: "https://www.youtube.com/shorts/TCzk4e3jB8c" },
      { name: "Wyciskanie na skosie na maszynie Smith'a", sets: 3, reps: "8, 8, 10", video: "https://www.youtube.com/watch?v=22-yQNZIkN0" },
      { name: "Rozpietki na maszynie Butterfly", sets: 3, reps: "12" },
      { name: "Wznosy na barki za soba", sets: 3, reps: "12", video: "https://youtube.com/shorts/bLQSdfQMtS0?feature=share" },
      { name: "Biceps jednoracz na modlitewniku", sets: 3, reps: "12", video: "https://www.youtube.com/watch?v=fuK3nFvwgXk" },
      { name: "Klasyczne pompki na ziemi", sets: 2, reps: "MAX" }
    ]
  },
  {
    name: "Trening 3",
    muscles: "FBW (Full Body)",
    exercises: [
      { name: "Sciaganie wyciagu szeroko lokcie", sets: 4, reps: "12, 10, 8, 8", video: "https://www.youtube.com/watch?v=094EyLsz7VM" },
      { name: "Wioslowanie na maszynie jednoracz", sets: 3, reps: "10", video: "https://www.youtube.com/shorts/s3gNtp358YE" },
      { name: "Uginanie nog lezac na maszynie", sets: 3, reps: "12, 10, 10", video: "https://www.youtube.com/shorts/xXDQTyI0ESQ" },
      { name: "Przysiady na maszynie Hack Squat", sets: 3, reps: "12, 10, 10", video: "https://www.youtube.com/watch?v=1AVQaldrnOk" },
      { name: "Wypychanie nog na suwnicy", sets: 3, reps: "12, 10, 10", video: "https://www.youtube.com/watch?v=-w1u2DtnPHo&t=1s" },
      { name: "Prostowanie nog na maszynie", sets: 3, reps: "12", video: "https://www.youtube.com/shorts/bkJKXQyOIMM" }
    ]
  },
  {
    name: "Trening 4",
    muscles: "Barki, Gora Klaty, Biceps",
    exercises: [
      { name: "Bok barku na lince", sets: 4, reps: "15, 12, 12, 10", video: "https://www.youtube.com/shorts/gsC3pd6lfKY" },
      { name: "Wyciskanie na gore klatki na hamerze", sets: 3, reps: "10, 10, 10", video: "https://www.youtube.com/watch?v=1BZgo2uGvZQ" },
      { name: "Wyciskanie barkow hantlami siedzac", sets: 3, reps: "8, 8, 8", ts: "49:20", video: "https://www.youtube.com/watch?v=qE-yhtVyRs8&t=1946s" },
      { name: "Przod barku na wyciagu", sets: 3, reps: "12", video: "https://www.youtube.com/shorts/-Scr0kgy200" },
      { name: "Tyl barku na maszynie Butterfly", sets: 3, reps: "12", video: "https://www.youtube.com/shorts/7tJ5ozfR6bk" },
      { name: "Biceps na wyciagu", sets: 3, reps: "12", ts: "1:10", video: "https://www.youtube.com/watch?v=RjmADgjekgA&t=9s" },
      { name: "Biceps 21'", sets: 3, reps: "21", video: "https://www.youtube.com/shorts/jgmESOA4J5E" }
    ]
  }
];

const ABS_EXERCISES = [
  { name: "Deska", sets: 4, reps: "1 min", ts: "1:05", video: "https://www.youtube.com/watch?v=y1hXARqhHZM" },
  { name: "Dead Bug", sets: 4, reps: "20", video: "https://www.youtube.com/watch?v=RvTbAWfLhmE" },
  { name: "Mountain Climber", sets: 4, reps: "12 na noge", ts: "5:11", video: "https://www.youtube.com/watch?v=sDCFiqyt_Rs&t=321s" },
  { name: "Spiecia brzucha", sets: 4, reps: "20", ts: "2:56", video: "https://www.youtube.com/watch?v=sDCFiqyt_Rs&t=321s" }
];

const ABS_SPLITS = [
  [[0,1],[2,3]],
  [[0,2],[1,3]],
  [[0,3],[1,2]]
];

const WEEK_TRAINING_DAYS = [
  [0, 2, 4, 6],
  [1, 2, 4, 5],
  [0, 2, 3, 6],
  [1, 3, 5, 6]
];

const DAY_NAMES_FULL = ["Poniedzialek","Wtorek","Sroda","Czwartek","Piatek","Sobota","Niedziela"];
const MONTH_NAMES = ["sty","lut","mar","kwi","maj","cze","lip","sie","wrz","paz","lis","gru"];
const MONTH_NAMES_FULL = ["stycznia","lutego","marca","kwietnia","maja","czerwca","lipca","sierpnia","wrzesnia","pazdziernika","listopada","grudnia"];
const MONTH_NAMES_TITLE = ["Styczen","Luty","Marzec","Kwiecien","Maj","Czerwiec","Lipiec","Sierpien","Wrzesien","Pazdziernik","Listopad","Grudzien"];

let currentMonthOffset = 0;

const APP_VERSION = '4';
if (localStorage.getItem('appVersion') !== APP_VERSION) {
  localStorage.removeItem('trainingStartDate');
  localStorage.removeItem('trainingOffset');
  localStorage.setItem('appVersion', APP_VERSION);
}

function getStartDate() {
  const s = localStorage.getItem('trainingStartDate');
  return s ? new Date(s) : new Date('2026-02-09');
}
function getStartTrainingOffset() {
  const s = localStorage.getItem('trainingOffset');
  return s !== null ? parseInt(s) : 2;
}
function setStartDate(v) { localStorage.setItem('trainingStartDate', v); render(); }
function setStartTrainingOffset(v) { localStorage.setItem('trainingOffset', v.toString()); render(); }

function getMondayOfWeek(date) {
  const d = new Date(date);
  const day = d.getDay();
  d.setDate(d.getDate() - (day === 0 ? 6 : day - 1));
  d.setHours(0,0,0,0);
  return d;
}
function daysBetween(a, b) { return Math.floor((b - a) / 86400000); }
function getCycleWeek(date) {
  const w = Math.floor(daysBetween(getMondayOfWeek(getStartDate()), getMondayOfWeek(date)) / 7);
  return ((w % 4) + 4) % 4;
}
function getDayOfWeek(date) { const d = date.getDay(); return d === 0 ? 6 : d - 1; }
function isTrainingDay(date) { return WEEK_TRAINING_DAYS[getCycleWeek(date)].includes(getDayOfWeek(date)); }

function countTrainingDaysBefore(date) {
  const totalWeeks = Math.floor(daysBetween(getMondayOfWeek(getStartDate()), getMondayOfWeek(date)) / 7);
  let count = Math.floor(totalWeeks / 4) * 16;
  const rem = ((totalWeeks % 4) + 4) % 4;
  for (let w = 0; w < rem; w++) count += WEEK_TRAINING_DAYS[w].length;
  const dow = getDayOfWeek(date);
  for (const d of WEEK_TRAINING_DAYS[getCycleWeek(date)]) { if (d < dow) count++; }
  return count;
}

function getTrainingForDate(date) {
  if (!isTrainingDay(date)) return null;
  const seqIdx = countTrainingDaysBefore(date);
  const trainingIdx = ((seqIdx + getStartTrainingOffset()) % 4 + 4) % 4;
  const cw = getCycleWeek(date);
  const posInWeek = WEEK_TRAINING_DAYS[cw].indexOf(getDayOfWeek(date));
  return { training: TRAININGS[trainingIdx], hasAbs: posInWeek === 0 || posInWeek === 2, cycleWeek: cw, trainingIdx };
}

function getAbsForDate(date) {
  const weekNum = Math.floor(daysBetween(getMondayOfWeek(getStartDate()), getMondayOfWeek(date)) / 7);
  const split = ABS_SPLITS[((weekNum % 3) + 3) % 3];
  const cw = getCycleWeek(date);
  const posInWeek = WEEK_TRAINING_DAYS[cw].indexOf(getDayOfWeek(date));
  const indices = split[posInWeek === 0 ? 0 : 1];
  return [ABS_EXERCISES[indices[0]], ABS_EXERCISES[indices[1]]];
}

function formatDate(date) { return `${date.getDate()} ${MONTH_NAMES_FULL[date.getMonth()]} ${date.getFullYear()}`; }
function sameDay(a, b) { return a.getDate() === b.getDate() && a.getMonth() === b.getMonth() && a.getFullYear() === b.getFullYear(); }
function toDateStr(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

const YT_SVG = `<svg viewBox="0 0 24 24"><path d="M23.5 6.2a3 3 0 00-2.1-2.1C19.5 3.5 12 3.5 12 3.5s-7.5 0-9.4.6A3 3 0 00.5 6.2 31.4 31.4 0 000 12a31.4 31.4 0 00.5 5.8 3 3 0 002.1 2.1c1.9.6 9.4.6 9.4.6s7.5 0 9.4-.6a3 3 0 002.1-2.1A31.4 31.4 0 0024 12a31.4 31.4 0 00-.5-5.8zM9.5 15.6V8.4l6.3 3.6-6.3 3.6z"/></svg>`;

function renderExerciseItem(ex, i, numClass) {
  let meta = `<span class="exercise-sets">${ex.sets}s Ã— ${ex.reps}</span>`;
  if (ex.ts) meta += `<span class="exercise-timestamp">${ex.ts}</span>`;
  let videoHtml = '';
  if (ex.video) {
    const label = ex.ts ? `Technika ${ex.ts}` : 'Technika';
    videoHtml = `<div><a href="${ex.video}" target="_blank" rel="noopener" class="video-btn">${YT_SVG} ${label}</a></div>`;
  }
  return `<li class="exercise-item">
    <div class="exercise-num ${numClass}">${i+1}</div>
    <div class="exercise-info">
      <div class="exercise-name">${ex.name}</div>
      <div class="exercise-meta">${meta}</div>
      ${videoHtml}
    </div>
  </li>`;
}

function renderTrainingHtml(tr, date) {
  const t = tr.training;
  let html = `<div class="training-card">
    <h2>${t.name}</h2>
    <div class="subtitle">${t.muscles}</div>
    <ul class="exercise-list">`;
  t.exercises.forEach((ex, i) => { html += renderExerciseItem(ex, i, ''); });
  html += `</ul></div>`;
  if (tr.hasAbs) {
    const abs = getAbsForDate(date);
    html += `<div class="abs-card">
      <h3>Brzuch</h3>
      <div class="subtitle">Dzisiejsze cwiczenia na brzuch</div>
      <ul class="exercise-list">`;
    abs.forEach((ex, i) => { html += renderExerciseItem(ex, i, 'abs-exercise-num'); });
    html += `</ul></div>`;
  }
  return html;
}

function openDayDetail(dateStr) {
  const date = new Date(dateStr); date.setHours(0,0,0,0);
  const today = new Date(); today.setHours(0,0,0,0);
  const tr = getTrainingForDate(date);
  let html = `<div class="panel-handle"></div>
    <div class="day-detail-header">
      <h2>${DAY_NAMES_FULL[getDayOfWeek(date)]}, ${date.getDate()} ${MONTH_NAMES_FULL[date.getMonth()]}</h2>
      <button class="day-detail-close" onclick="closeDayDetail()">&times;</button>
    </div>`;
  if (sameDay(date, today)) html += `<span class="day-detail-badge" style="background:#6c5ce720;color:#6c5ce7;">DZISIAJ</span>`;
  if (tr) {
    html += `<span class="day-detail-badge status-training">TRENING</span>`;
    html += renderTrainingHtml(tr, date);
  } else {
    html += `<span class="day-detail-badge status-rest">ODPOCZYNEK</span>`;
    html += `<div class="rest-message"><div class="icon">&#128564;</div><p>Tego dnia odpoczywasz.</p></div>`;
  }
  document.getElementById('day-detail-panel').innerHTML = html;
  document.getElementById('day-detail-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeDayDetail(e) {
  if (e && e.target && e.target !== document.getElementById('day-detail-overlay')) return;
  document.getElementById('day-detail-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

function changeMonth(dir) { currentMonthOffset += dir; renderMonthCalendar(); }

function renderMonthCalendar() {
  const today = new Date(); today.setHours(0,0,0,0);
  const viewDate = new Date(today.getFullYear(), today.getMonth() + currentMonthOffset, 1);
  const year = viewDate.getFullYear(), month = viewDate.getMonth();
  document.getElementById('month-title').textContent = `${MONTH_NAMES_TITLE[month]} ${year}`;
  const startDow = getDayOfWeek(new Date(year, month, 1));
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  let html = '';
  for (let i = 0; i < startDow; i++) html += '<div class="mcell empty"></div>';
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d); date.setHours(0,0,0,0);
    const tr = getTrainingForDate(date);
    const cls = ['mcell'];
    if (sameDay(date, today)) cls.push('today');
    if (tr) cls.push('training-day');
    html += `<div class="${cls.join(' ')}" onclick="openDayDetail('${toDateStr(date)}')">
      <div class="mday">${d}</div>
      ${tr ? `<div class="mtraining">T${tr.trainingIdx+1}</div>` : ''}
      ${tr && tr.hasAbs ? '<div class="mabs-dot"></div>' : ''}
    </div>`;
  }
  document.getElementById('month-grid').innerHTML = html;
}

function render() {
  const today = new Date(); today.setHours(0,0,0,0);
  document.getElementById('today-date').textContent = formatDate(today);
  document.getElementById('today-day').textContent = DAY_NAMES_FULL[getDayOfWeek(today)];
  const tr = getTrainingForDate(today);
  const badge = document.getElementById('status-badge');
  const content = document.getElementById('today-content');
  if (tr) {
    badge.innerHTML = `<span class="status-badge status-training">DZIEN TRENINGOWY</span>`;
    content.innerHTML = renderTrainingHtml(tr, today);
  } else {
    badge.innerHTML = `<span class="status-badge status-rest">DZIEN ODPOCZYNKU</span>`;
    content.innerHTML = `<div class="rest-message"><div class="icon">&#128564;</div><p>Dzisiaj odpoczywasz.<br>Regeneracja jest wazna!</p></div>`;
  }
  renderMonthCalendar();
  // Next trainings
  let nextHtml = '';
  let count = 0, checkDate = new Date(today);
  checkDate.setDate(checkDate.getDate() + 1);
  while (count < 5) {
    const t = getTrainingForDate(checkDate);
    if (t) {
      const ds = toDateStr(checkDate);
      nextHtml += `<div class="next-item" onclick="openDayDetail('${ds}')">
        <div class="next-date"><div class="d">${checkDate.getDate()}</div><div class="m">${MONTH_NAMES[checkDate.getMonth()]}</div></div>
        <div class="next-info"><div class="name">${t.training.name}</div><div class="muscles">${t.training.muscles}</div></div>
        ${t.hasAbs ? '<span class="next-abs-badge">+ brzuch</span>' : ''}
      </div>`;
      count++;
    }
    checkDate = new Date(checkDate); checkDate.setDate(checkDate.getDate() + 1);
  }
  document.getElementById('next-list').innerHTML = nextHtml;
  document.getElementById('cycle-info').textContent = `Tydzien ${getCycleWeek(today)+1} z 4 w cyklu`;
  // All trainings
  let allHtml = '';
  TRAININGS.forEach(t => {
    allHtml += `<div class="training-card"><h3>${t.name}</h3><div class="muscles-tag">${t.muscles}</div><ul class="exercise-list">`;
    t.exercises.forEach((ex, i) => { allHtml += renderExerciseItem(ex, i, ''); });
    allHtml += `</ul></div>`;
  });
  allHtml += `<div class="abs-card"><h3>Brzuch</h3><div class="subtitle">2x w tygodniu, 2+2 cwiczenia (rotacja co tydzien)</div><ul class="exercise-list">`;
  ABS_EXERCISES.forEach((ex, i) => { allHtml += renderExerciseItem(ex, i, 'abs-exercise-num'); });
  allHtml += `</ul></div>`;
  document.getElementById('all-trainings').innerHTML = allHtml;
  document.getElementById('start-date-input').value = getStartDate().toISOString().split('T')[0];
}

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  event.currentTarget.classList.add('active');
  window.scrollTo(0, 0);
}

document.getElementById('start-date-input').addEventListener('change', function() { setStartDate(this.value); });

function calibrate(idx) {
  const today = new Date(); today.setHours(0,0,0,0);
  let d = new Date(today);
  for (let i = 0; i < 7; i++) { if (isTrainingDay(d)) break; d.setDate(d.getDate() - 1); }
  setStartTrainingOffset(((idx - countTrainingDaysBefore(d)) % 4 + 4) % 4);
}

render();
</script>
</body>
</html>
